from flask import Flask
from threading import Thread
import discord
from discord.ext import commands
import os
import random
import string
import base64
import asyncio

# Flask app for keeping bot alive
app = Flask(__name__)

@app.route('/')
def home():
    return "Bot is running!"

def run_flask():
    app.run(host='0.0.0.0', port=8080)

# Khá»Ÿi cháº¡y Flask trong thread riÃªng
flask_thread = Thread(target=run_flask)
flask_thread.daemon = True
flask_thread.start()

# Discord Bot
intents = discord.Intents.default()
intents.message_content = True

bot = commands.Bot(command_prefix='!', intents=intents, help_command=None)

def generate_encryption_key():
    """Táº¡o key mÃ£ hÃ³a ngáº«u nhiÃªn"""
    return ''.join(random.choices(string.ascii_letters + string.digits, k=16))  # Giáº£m Ä‘á»™ dÃ i key

def xor_encrypt(data, key):
    """MÃ£ hÃ³a dá»¯ liá»‡u báº±ng XOR"""
    encrypted = bytearray()
    key_bytes = key.encode('utf-8')
    for i, byte in enumerate(data):
        encrypted.append(byte ^ key_bytes[i % len(key_bytes)])
    return bytes(encrypted)

def create_protected_lua(original_code, key):
    """Táº¡o file Lua Ä‘Æ°á»£c báº£o vá»‡ vá»›i code gá»‘c bÃªn trong"""
    # MÃ£ hÃ³a code gá»‘c
    encrypted_data = xor_encrypt(original_code.encode('utf-8'), key)
    encrypted_b64 = base64.b64encode(encrypted_data).decode('utf-8')
    
    # Táº¡o file Lua Ä‘Æ¡n giáº£n vÃ  cháº¯c cháº¯n cháº¡y Ä‘Æ°á»£c
    protected_code = f'''-- File Ä‘Æ°á»£c báº£o vá»‡
-- Auto-generated by Discord Bot

local encrypted = "{encrypted_b64}"
local key = "{key}"

-- HÃ m decode base64 Ä‘Æ¡n giáº£n
local function b64_decode(data)
    local b64chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'
    local result = ""
    
    data = string.gsub(data, '[^'..b64chars..'=]', '')
    
    for i = 1, #data, 4 do
        local chunk = data:sub(i, i+3)
        if #chunk < 4 then break end
        
        local a = (b64chars:find(chunk:sub(1,1)) - 1) or 0
        local b = (b64chars:find(chunk:sub(2,2)) - 1) or 0
        local c = (b64chars:find(chunk:sub(3,3)) - 1) or 0
        local d = (b64chars:find(chunk:sub(4,4)) - 1) or 0
        
        local combined = a * 262144 + b * 4096 + c * 64 + d
        
        local bytes = {{
            math.floor(combined / 65536) % 256,
            math.floor(combined / 256) % 256,
            combined % 256
        }}
        
        for j = 1, #chunk-1 do
            if bytes[j] then
                result = result .. string.char(bytes[j])
            end
        end
    end
    
    return result
end

-- HÃ m giáº£i mÃ£ XOR
local function xor_decrypt(data, key)
    local result = ""
    local key_len = #key
    
    for i = 1, #data do
        local data_byte = data:byte(i)
        local key_byte = key:byte((i - 1) % key_len + 1)
        local decrypted_byte = data_byte ~ key_byte
        result = result .. string.char(decrypted_byte)
    end
    
    return result
end

-- Main execution
local function main()
    -- Giáº£i mÃ£
    local decoded_data = b64_decode(encrypted)
    local original_code = xor_decrypt(decoded_data, key)
    
    -- Thá»±c thi code gá»‘c
    local func, err = load(original_code)
    if func then
        return func()
    else
        -- Náº¿u load tháº¥t báº¡i, thá»­ vá»›i mode text
        local success, result = pcall(function()
            local f = loadstring(original_code)
            if f then return f() end
        end)
        
        if not success then
            error("Failed to execute original code: " .. (err or "unknown error"))
        end
    end
end

-- Cháº¡y chÆ°Æ¡ng trÃ¬nh
local success, err = pcall(main)
if not success then
    print("Execution error: " .. tostring(err))
end
'''
    return protected_code

def create_simple_protected_lua(original_code, key):
    """PhiÃªn báº£n Ä‘Æ¡n giáº£n hÆ¡n Ä‘á»ƒ Ä‘áº£m báº£o cháº¡y Ä‘Æ°á»£c"""
    # MÃ£ hÃ³a code gá»‘c
    encrypted_data = xor_encrypt(original_code.encode('utf-8'), key)
    encrypted_b64 = base64.b64encode(encrypted_data).decode('utf-8')
    
    # Táº¡o file Lua cá»±c ká»³ Ä‘Æ¡n giáº£n
    protected_code = f'''-- Protected Lua File
local e="{encrypted_b64}"
local k="{key}"

-- Simple Base64 decode
function bd(d)
    local m="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"
    local r=""
    d=d:gsub("[^"..m.."=]","")
    for i=1,#d,4 do
        local c=d:sub(i,i+3)
        if #c<4 then break end
        local a=(m:find(c:sub(1,1))-1)or 0
        local b=(m:find(c:sub(2,2))-1)or 0
        local c=(m:find(c:sub(3,3))-1)or 0
        local d=(m:find(c:sub(4,4))-1)or 0
        local n=a*262144+b*4096+c*64+d
        local x={{math.floor(n/65536)%256,math.floor(n/256)%256,n%256}}
        for j=1,#c-1 do if x[j] then r=r..string.char(x[j]) end end
    end
    return r
end

-- Simple XOR decrypt
function xd(d,k)
    local r=""
    for i=1,#d do
        local db=d:byte(i)
        local kb=k:byte((i-1)%#k+1)
        r=r..string.char(db~kb)
    end
    return r
end

-- Execute
local dc=bd(e)
local oc=xd(dc,k)
local f,err=load(oc)
if f then f() else print("Error:",err) end
'''
    return protected_code

@bot.event
async def on_ready():
    print(f'{bot.user} Ä‘Ã£ káº¿t ná»‘i thÃ nh cÃ´ng!')
    await bot.change_presence(activity=discord.Game(name="!mahoa Ä‘á»ƒ mÃ£ hÃ³a code"))
    
    try:
        synced = await bot.tree.sync()
        print(f"ÄÃ£ Ä‘á»“ng bá»™ {len(synced)} slash command(s)")
    except Exception as e:
        print(f"Lá»—i Ä‘á»“ng bá»™ slash commands: {e}")

@bot.event
async def on_command_error(ctx, error):
    if isinstance(error, commands.CommandNotFound):
        return
    await ctx.send(f"CÃ³ lá»—i xáº£y ra: {str(error)}")

@bot.command(name='mahoa')
async def encrypt_code(ctx):
    """Lá»‡nh mÃ£ hÃ³a file code"""
    if not ctx.message.attachments:
        await ctx.send(" Vui lÃ²ng gá»­i file code Ä‘Ã­nh kÃ¨m khi sá»­ dá»¥ng lá»‡nh `!mahoa`")
        return
    
    attachment = ctx.message.attachments[0]
    
    # Kiá»ƒm tra file type
    valid_extensions = ['.lua', '.txt', '.py', '.js', '.cpp', '.c', '.java', '.php', '.xml', '.json']
    if not any(attachment.filename.lower().endswith(ext) for ext in valid_extensions):
        await ctx.send(" File khÃ´ng há»£p lá»‡. Chá»‰ cháº¥p nháº­n file code")
        return
    
    try:
        wait_msg = await ctx.send(" Äang xá»­ lÃ½ file...")
        
        # Táº£i file
        file_content = await attachment.read()
        original_code = file_content.decode('utf-8')
        
        # Táº¡o key mÃ£ hÃ³a (ngáº¯n hÆ¡n Ä‘á»ƒ trÃ¡nh lá»—i)
        encryption_key = generate_encryption_key()
        
        # Táº¡o file Ä‘Æ°á»£c báº£o vá»‡ - dÃ¹ng phiÃªn báº£n Ä‘Æ¡n giáº£n
        protected_lua_code = create_simple_protected_lua(original_code, encryption_key)
        
        # Táº¡o tÃªn file má»›i
        original_name = os.path.splitext(attachment.filename)[0]
        encrypted_filename = f"{original_name}_protected.lua"
        
        # LÆ°u file táº¡m
        with open(encrypted_filename, 'w', encoding='utf-8') as f:
            f.write(protected_lua_code)
        
        # Kiá»ƒm tra code trÆ°á»›c khi gá»­i
        print(f"ÄÃ£ táº¡o file: {encrypted_filename}")
        print(f"Key length: {len(encryption_key)}")
        print(f"Original code length: {len(original_code)}")
        print(f"Protected code length: {len(protected_lua_code)}")
        
        # Gá»­i file Ä‘Ã£ mÃ£ hÃ³a
        with open(encrypted_filename, 'rb') as f:
            file = discord.File(f, filename=encrypted_filename)
            embed = discord.Embed(
                title=" MÃ£ HÃ³a ThÃ nh CÃ´ng",
                description=f"File `{attachment.filename}` Ä‘Ã£ Ä‘Æ°á»£c báº£o vá»‡",
                color=0x00ff00
            )
            embed.add_field(
                name=" ThÃ´ng tin",
                value="â€¢ File .lua Ä‘Ã£ sáºµn sÃ ng Ä‘á»ƒ cháº¡y\nâ€¢ Code gá»‘c Ä‘Æ°á»£c báº£o vá»‡ bÃªn trong\nâ€¢ TÆ°Æ¡ng thÃ­ch vá»›i Lua 5.1+",
                inline=False
            )
            embed.add_field(
                name=" Gá»¡ lá»—i",
                value="Náº¿u file khÃ´ng cháº¡y, hÃ£y kiá»ƒm tra:\nâ€¢ Lua version (5.1+)\nâ€¢ Code gá»‘c cÃ³ lá»—i syntax khÃ´ng",
                inline=False
            )
            await ctx.send(embed=embed, file=file)
        
        # XÃ³a file táº¡m
        os.remove(encrypted_filename)
        await wait_msg.delete()
        
    except Exception as e:
        await ctx.send(f" Lá»—i khi xá»­ lÃ½ file: {str(e)}")
        import traceback
        traceback.print_exc()

@bot.command(name='test')
async def test_command(ctx):
    """Táº¡o file test Ä‘Æ¡n giáº£n Ä‘á»ƒ kiá»ƒm tra"""
    test_code = '''print("Hello World!")
for i = 1, 5 do
    print("Count:", i)
end
print("Test completed!")'''
    
    try:
        encryption_key = generate_encryption_key()
        protected_lua_code = create_simple_protected_lua(test_code, encryption_key)
        
        with open("test_protected.lua", 'w', encoding='utf-8') as f:
            f.write(protected_lua_code)
        
        with open("test_protected.lua", 'rb') as f:
            file = discord.File(f, filename="test_example.lua")
            await ctx.send(" File test Ä‘Æ¡n giáº£n:", file=file)
        
        os.remove("test_protected.lua")
        
    except Exception as e:
        await ctx.send(f" Lá»—i test: {str(e)}")

@bot.command(name='ping')
async def ping(ctx):
    """Kiá»ƒm tra Ä‘á»™ trá»…"""
    latency = round(bot.latency * 1000)
    await ctx.send(f' Ping! Äá»™ trá»…: {latency}ms')

@bot.command(name='trogiup')
async def help_command(ctx):
    """HÆ°á»›ng dáº«n sá»­ dá»¥ng"""
    help_text = """
**ðŸ¤– Bot Báº£o Vá»‡ Code - FIXED**

**Lá»‡nh:**
`!mahoa` - Báº£o vá»‡ file code (Ä‘Ã£ sá»­a lá»—i)
`!test` - Táº¡o file test Ä‘á»ƒ kiá»ƒm tra
`!ping` - Kiá»ƒm tra Ä‘á»™ trá»…
`!trogiup` - Hiá»ƒn thá»‹ hÆ°á»›ng dáº«n

**ÄÃƒ Sá»¬A Lá»–I:**
â€¢ Base64 decode Ä‘Æ¡n giáº£n hÆ¡n
â€¢ XOR decrypt tá»‘i Æ°u
â€¢ TÆ°Æ¡ng thÃ­ch Lua 5.1+
â€¢ Xá»­ lÃ½ lá»—i tá»‘t hÆ¡n

**Há»— trá»£ file:** .lua, .txt, .py, .js, .cpp, .c, .java, .php, .xml, .json
"""
    await ctx.send(help_text)

# Slash command support
@bot.tree.command(name="mahoa", description="Báº£o vá»‡ file code thÃ nh file .lua (Ä‘Ã£ sá»­a lá»—i)")
async def slash_encrypt(interaction: discord.Interaction):
    """Slash command cho mÃ£ hÃ³a"""
    await interaction.response.send_message("Vui lÃ²ng gá»­i file code Ä‘Ã­nh kÃ¨m khi sá»­ dá»¥ng lá»‡nh nÃ y. Sá»­ dá»¥ng `!mahoa` vá»›i file Ä‘Ã­nh kÃ¨m.")

@bot.event
async def on_message(message):
    if message.content in ['/mahoa', '!mahoa'] and not message.attachments:
        await message.channel.send("âŒ Vui lÃ²ng gá»­i file code Ä‘Ã­nh kÃ¨m khi sá»­ dá»¥ng lá»‡nh nÃ y.")
    
    await bot.process_commands(message)

# Cháº¡y bot vá»›i token tá»« environment variable
if __name__ == "__main__":
    token = os.environ.get('TOKEN')
    if not token:
        print("Lá»—i: TOKEN khÃ´ng Ä‘Æ°á»£c tÃ¬m tháº¥y trong environment variables!")
        exit(1)
    
    print("ðŸ¤– Äang khá»Ÿi Ä‘á»™ng bot...")
    print("ðŸŒ Flask server Ä‘ang cháº¡y trÃªn port 8080")
    bot.run(token)
